// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// RESTAURANT & USER MANAGEMENT
// ============================================

model Restaurant {
  id                          String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                        String
  description                 String?
  phone                       String         @unique
  email                       String?
  address                     String?
  logo                        String?
  momoNumber                  String         @map("momo_number")
  momoName                    String         @map("momo_name")
  whatsappNumber              String?        @unique @map("whatsapp_number")
  whatsappPhoneNumberId       String?        @unique @map("whatsapp_phone_number_id")
  whatsappBusinessAccountId   String?        @map("whatsapp_business_account_id")
  isActive                    Boolean        @default(true) @map("is_active")
  subscriptionStatus          String         @default("TRIAL") @map("subscription_status")
  trialEndsAt                 DateTime?      @map("trial_ends_at")
  createdAt                   DateTime       @default(now()) @map("created_at")
  updatedAt                   DateTime       @updatedAt @map("updated_at")

  // Relations
  users           User[]
  categories      MenuCategory[]
  orders          Order[]
  customers       Customer[]
  conversations   Conversation[]
  userRoles       UserRoleRecord[]

  @@map("restaurants")
}

model User {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String?     @unique
  phone         String?     @unique
  password      String
  name          String
  role          UserRole    @default(RESTAURANT_ADMIN)
  restaurantId  String?     @map("restaurant_id") @db.Uuid
  isActive      Boolean     @default(true) @map("is_active")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  restaurant    Restaurant? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@map("users")
}

/// Canonical role store for Supabase RLS.
/// userId maps to auth.users.id (managed by Supabase Auth).
/// NEVER read auth.jwt() -> user_metadata for role â€” use this table.
model UserRoleRecord {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String      @unique @map("user_id") @db.Uuid
  role          String      // 'SUPER_ADMIN' | 'RESTAURANT_ADMIN'
  restaurantId  String?     @map("restaurant_id") @db.Uuid
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  restaurant    Restaurant? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([restaurantId])
  @@map("user_roles")
}

enum UserRole {
  SUPER_ADMIN       // Platform admin - manages all restaurants
  RESTAURANT_ADMIN  // Restaurant owner/manager - manages own restaurant
}

// ============================================
// CUSTOMER MANAGEMENT
// ============================================

model Customer {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  phone         String
  name          String?
  restaurantId  String        @map("restaurant_id") @db.Uuid
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  restaurant    Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orders        Order[]
  conversation  Conversation?

  @@unique([phone, restaurantId])
  @@map("customers")
}

// ============================================
// MENU MANAGEMENT
// ============================================

model MenuCategory {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  description   String?
  sortOrder     Int         @default(0) @map("sort_order")
  isActive      Boolean     @default(true) @map("is_active")
  restaurantId  String      @map("restaurant_id") @db.Uuid
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  items         MenuItem[]

  @@map("menu_categories")
}

model MenuItem {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  description   String?
  price         Float
  categoryId    String        @map("category_id") @db.Uuid
  imageUrl      String?       @map("image_url")
  isAvailable   Boolean       @default(true) @map("is_available")
  sortOrder     Int           @default(0) @map("sort_order")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  category      MenuCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  orderItems    OrderItem[]

  @@map("menu_items")
}

// ============================================
// ORDER MANAGEMENT
// ============================================

model Order {
  id                String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderNumber       String        @unique @map("order_number")
  customerId        String        @map("customer_id") @db.Uuid
  restaurantId      String        @map("restaurant_id") @db.Uuid
  totalAmount       Float         @map("total_amount")
  status            OrderStatus   @default(PENDING)
  paymentStatus     PaymentStatus @default(UNPAID) @map("payment_status")
  deliveryAddress   String?       @map("delivery_address")
  customerNotes     String?       @map("customer_notes")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  customer          Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  restaurant        Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  items             OrderItem[]

  @@map("orders")
}

model OrderItem {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId       String      @map("order_id") @db.Uuid
  menuItemId    String      @map("menu_item_id") @db.Uuid
  itemName      String      @map("item_name")
  itemPrice     Float       @map("item_price")
  quantity      Int
  subtotal      Float
  createdAt     DateTime    @default(now()) @map("created_at")

  // Relations
  order         Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem      MenuItem    @relation(fields: [menuItemId], references: [id], onDelete: Restrict)

  @@map("order_items")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PENDING_VERIFICATION
  VERIFIED
  FAILED
}

// ============================================
// CONVERSATION MANAGEMENT
// ============================================

model Conversation {
  id            String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId    String              @unique @map("customer_id") @db.Uuid
  restaurantId  String              @map("restaurant_id") @db.Uuid
  state         ConversationState   @default(WELCOME)
  context       Json?
  lastMessageAt DateTime            @default(now()) @map("last_message_at")
  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")

  // Relations
  customer      Customer            @relation(fields: [customerId], references: [id], onDelete: Cascade)
  restaurant    Restaurant          @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@map("conversations")
}

enum ConversationState {
  WELCOME
  SELECT_CATEGORY
  SELECT_ITEM
  SELECT_QUANTITY
  ADD_MORE
  CONFIRM_ORDER
  PAYMENT_INSTRUCTIONS
  PAYMENT_CONFIRMATION
}
